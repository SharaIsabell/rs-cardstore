<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login/Cadastro - RS Card Store</title>
    <link rel="stylesheet" href="../css/login.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Lato:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="particles-js"></div>
    <div class="auth-container">
        <div class="forms-container">
            <div class="login-form">
                <h2>Bem-vindo de volta!</h2>
                <p>Entre para dominar o jogo.</p>
                <% if (typeof message !== 'undefined' && message) { %>
                    <div class="success-message"><%= message %></div>
                <% } %>
                <% if (typeof errorMessage !== 'undefined' && errorMessage && errorMessage !== 'As senhas não coincidem.') { %>
                    <div class="error-message"><%= errorMessage %></div>
                <% } %>
                
                <form action="/login" method="POST">
                    <div class="input-group">
                        <input type="email" id="loginEmail" name="email" required>
                        <label for="loginEmail">Email</label>
                    </div>
                    <div class="input-group">
                        <input type="password" id="loginPassword" name="senha" required>
                        <label for="loginPassword">Senha</label>
                    </div>
                    <button type="submit" class="cta-button">Entrar</button>
                </form>
                <div class="auth-footer">
                    <a href="#">Esqueceu a senha?</a>
                </div>
            </div>

            <div class="register-form">
                <h2>Crie sua conta!</h2>
                <p>Junte-se a nós e comece a jogar.</p>
                <form id="registerForm" action="/register" method="POST">
                    <div class="input-group">
                        <input type="text" id="registerName" name="nome" required placeholder=" ">
                        <label for="registerName">Nome Completo</label>
                    </div>
                    <div class="input-group">
                        <input type="email" id="registerEmail" name="email" required placeholder=" ">
                        <label for="registerEmail">Email</label>
                    </div>
                     <div class="input-group">
                        <input type="tel" id="registerTelefone" name="telefone" required minlength="11" maxlength="11" pattern="[0-9]{11}" title="O telefone deve conter exatamente 11 dígitos." oninput="this.value = this.value.replace(/\D/g, '')" placeholder=" ">
                        <label for="registerTelefone">Telefone</label>
                    </div>
                    <div class="input-group">
                        <input type="password" id="registerPassword" name="senha" required minlength="8" placeholder=" ">
                        <label for="registerPassword">Senha</label>
                    </div>
                    <div class="input-group">
                        <input type="password" id="confirmPassword" name="confirmSenha" required placeholder=" ">
                        <label for="confirmPassword">Confirmar Senha</label>
                    </div>
                    <button type="submit" class="cta-button" id="registerButton">Cadastrar</button>
                </form>
            </div>
        </div>

        <div class="overlay-container">
            <div class="overlay">
                <div class="overlay-panel overlay-left">
                    <h1>Já tem uma conta?</h1>
                    <p>Para se manter conectado, faça login com suas informações.</p>
                    <button class="ghost cta-button" id="signIn">Login</button>
                </div>
                <div class="overlay-panel overlay-right">
                    <h1>Novo por aqui?</h1>
                    <p>Cadastre-se e comece sua jornada no RS Card Store!</p>
                    <button class="ghost cta-button" id="signUp">Cadastro</button>
                </div>
            </div>
        </div>
    </div>

    <div id="popup" class="popup-overlay">
        <div class="popup-content">
            <h3 id="popup-title">Atenção!</h3>
            <p id="popup-message"></p>
            <button id="close-popup" class="popup-button">Entendi</button>
        </div>
    </div>
    <script src="../js/particles.min.js"></script>
    <script src="../js/login.js"></script>
    <script src="../js/auth.js"></script>

     <script>
        document.addEventListener('DOMContentLoaded', () => {
            const registerForm = document.getElementById('registerForm');
            const registerButton = document.getElementById('registerButton');
            const popup = document.getElementById('popup');
            const popupTitle = document.getElementById('popup-title');
            const popupMessage = document.getElementById('popup-message');
            const closePopupButton = document.getElementById('close-popup');

            const showPopup = (title, message, isSuccess = false) => {
                popupTitle.textContent = title;
                popupMessage.textContent = message;
                popupTitle.style.color = isSuccess ? '#28a745' : 'var(--color-orange-vibrant)';
                popup.classList.add('active');
            };

            // Função para fechar o pop-up
            const closePopup = () => {
                popup.classList.remove('active');
            };
            
            closePopupButton.addEventListener('click', closePopup);
            popup.addEventListener('click', (event) => {
                if (event.target === popup) {
                    closePopup();
                }
            });

            // Interceptar o envio do formulário de cadastro
            if (registerForm) {
                registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Impede o recarregamento da página

                    const originalButtonText = registerButton.textContent;
                    registerButton.textContent = 'Enviando...';
                    registerButton.disabled = true;

                    // Coleta os dados do formulário
                    const formData = new FormData(registerForm);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        const response = await fetch('/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json' // Informa ao servidor que esperamos JSON
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showPopup('Sucesso!', result.message, true);
                            registerForm.reset(); // Limpa o formulário
                            setTimeout(() => {
                                document.querySelector('.auth-container').classList.remove('right-panel-active');
                                closePopup();
                            }, 3000);
                        } else { 
                            showPopup('Atenção!', result.message, false);
                        }

                    } catch (error) {
                        console.error('Erro de rede:', error);
                        showPopup('Erro!', 'Não foi possível conectar ao servidor. Tente novamente mais tarde.', false);
                    } finally {
                        registerButton.textContent = originalButtonText;
                        registerButton.disabled = false;
                    }
                });
            }

            const successMessage = "<%= typeof message !== 'undefined' ? message : '' %>";
            if (successMessage) {
                 showPopup('Sucesso!', successMessage, true);
            }
        });
    </script>
</body>
</html>